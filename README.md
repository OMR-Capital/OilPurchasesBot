## Описание

Бот предназначен для управления закупками отработанного масла.

В боте есть следующие роли:
1. Сотрудник (employee) - может создавать заявки на закупки и отгрузки масла, уведомлять о заправке
2. Администратор (admin) - подтверждает заявки на закупку, имеет доступ к статистике закупок
3. Супер-пользователь (superuser) - имеет доступ к функционалу администраторов, а также может создавать и удалять аккаунты

## Функционал

### 1. Вход

В начале диалога бот спрашивает ключ доступа пользователя.
Доступ к списку всех ключей доступа есть у супер-пользователя.

### 2. Создание заявки на закупку

Сотрудника создает заявку на закупку масла.

В заявке указывается регион, тип клиента, тип договора, объем и единицы измерения, инн и реквизиты для оплаты

После успешного заполнения формы заявка приходит всем администраторам и попадает в статистику.
Под сообщение у администратора есть кнопка подтверждения заявки.

После подтверждения заявки сотруднику приходит сообщение, и запись о заявке в статистике помечается как подтвержденная

### 3. Создание заявки на отгрузку

Аналогично закупке

### 4. Заправка

Сотрудник может отмечать заправку своего транспорта и ее стоимость.
Данные о заправках также хранятся в статистике.

### 5. Управление аккаунтами

Супер-пользователь может создавать и удалять аккаунты.

При создании аккаунта генерируется ключ доступа. Этот ключ необходимо передать сотруднику для доступа к боту.

### 6. Статистика

Статистика хранится в Google таблице.

Страницы Raw и Sorted - служебные, они заполняются ботом.

Остальные страницы содержат обработанную информацию о закупках, заправках, премии, информацию по каждому пользователю.

Страницы Премии2 не обновляется автоматически из-за проблем с формулой в Google Sheets, поэтому ее приходилось периодически обновлять в ручную.
Возможно сейчас формулы Google Sheets уже позволяют это исправить, или можно целиком генерировать отчеты кодом и отказаться от формул.

## Архитектура

Бот изначально разрабатывался для работы на платформе Deta Space, поэтому весь код рассчитан на ее инфраструктуру.

В боте есть два "микросервиса" (в терминах Deta Space): BotMicro для управления ботом и StatisticsMicro для формирования статистики в Google Sheets.

Так как обновление статистики занимало какое-то время, а каждый вызов сервиса в Deta Space должен был укладываться в минуту,
она была вынесена в отдельный сервис (StatisticsMicro) и запускалась по расписанию.
Чтобы усложнить жизнь, StatisticsMicro еще и копировал данные из BotMicro в собственную базу, общаясь с ним через API.
Пре переделке бота это место можно сильно упростить, избавившись от StatisticsMicro и просто обновляя статистику после соответствующих событий.

Сервисы использовали базу данных Deta Base через ORM odetam. Структуру всех таблиц можно найти в директории `BotMicro/models` и `StatisticsMicro/models`

## Требуемые доработки

- Переписать работу с данными с Deta Base на любое другое хранилище
- Переписать обновление статистики - либо целиком отказаться от StatisticsMicro и внести его функционал в основной сервис, или переписать запуск по рассписанию Deta на какой-нибудь cron
- По возможности исправить обновление страницы "Премии2"
- Задеплоить на каком-нибудь сервере, можно при необходимости переписать вебхуки на лонг поллинг, чтобы ssl не настраивать
- Восстановить данные: бэкапа нет, но данных из Google таблицы достаточно для восстановления истории закупок
